<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Feedback Collection System</title>
    <link rel="stylesheet" href="css/admin_dashboard.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="login-header">
                <h2>Admin Login</h2>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="adminUsername">Username</label>
                    <input type="text" id="adminUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" name="password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <div id="loginMessage" class="message" style="display: none;"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="dashboard" style="display: none;">
        <header class="dashboard-header">
            <div class="header-content">
                <h1>Admin Dashboard</h1>
                <div class="header-actions">
                    <span id="adminName">Admin</span>
                    <button id="logoutBtn" class="logout-btn">Logout</button>
                </div>
            </div>
        </header>

        <main class="dashboard-main">
            <!-- Analytics Section -->
            <section class="analytics-section">
                <h2>Dashboard Statistics</h2>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Total Feedback</h3>
                        <div class="analytics-value" id="totalFeedback">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Average Rating</h3>
                        <div class="analytics-value" id="avgRating">0.0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Pending</h3>
                        <div class="analytics-value" id="pendingCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Approved</h3>
                        <div class="analytics-value" id="approvedCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Rejected</h3>
                        <div class="analytics-value" id="rejectedCount">0</div>
                    </div>
                </div>
                
                <!-- Category Distribution Chart -->
                <div class="category-chart-section">
                    <h3>Category Distribution</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Admin Dashboard JavaScript
        class AdminDashboard {
            constructor() {
                this.token = null;
                this.init();
            }

            init() {
                // Check if token exists in localStorage
                this.token = localStorage.getItem('admin_token');
                
                if (this.token) {
                    // Verify token and show dashboard
                    this.verifyToken();
                } else {
                    // Show login modal
                    this.showLogin();
                }
                
                // Set up event listeners
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Login form
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                }

                // Logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.handleLogout());
                }
            }

            async verifyToken() {
                try {
                    const response = await fetch('/api/auth/verify', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        document.getElementById('adminName').textContent = result.admin.username;
                        this.showDashboard();
                        this.loadDashboardStats();
                        this.loadCategoryDistribution();
                    } else {
                        // Token is invalid, show login
                        this.showLogin();
                        localStorage.removeItem('admin_token');
                    }
                } catch (error) {
                    console.error('Error verifying token:', error);
                    this.showLogin();
                    localStorage.removeItem('admin_token');
                }
            }

            showLogin() {
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }

            showDashboard() {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
            }

            async handleLogin(e) {
                e.preventDefault();
                
                const username = document.getElementById('adminUsername').value.trim();
                const password = document.getElementById('adminPassword').value;
                const loginMessage = document.getElementById('loginMessage');

                if (!username || !password) {
                    this.showToast('Please enter both username and password', 'error');
                    return;
                }

                try {
                    // Show loading state
                    const loginBtn = document.querySelector('.login-btn');
                    const originalText = loginBtn.textContent;
                    loginBtn.textContent = 'Logging in...';
                    loginBtn.disabled = true;

                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        this.token = result.token;
                        localStorage.setItem('admin_token', this.token);
                        document.getElementById('adminName').textContent = result.admin.username;
                        this.showDashboard();
                        this.loadDashboardStats();
                        this.loadCategoryDistribution();
                        this.showToast('Login successful!', 'success');
                        
                        // Clear form
                        document.getElementById('loginForm').reset();
                    } else {
                        console.error('Login failed:', result.message);
                        this.showToast(result.message || 'Login failed. Please check your credentials.', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    this.showToast('Network error. Please check your connection and try again.', 'error');
                } finally {
                    // Reset loading state
                    const loginBtn = document.querySelector('.login-btn');
                    loginBtn.textContent = 'Login';
                    loginBtn.disabled = false;
                }
            }

            handleLogout() {
                if (confirm('Are you sure you want to logout?')) {
                    this.token = null;
                    localStorage.removeItem('admin_token');
                    this.showLogin();
                }
            }

            async loadDashboardStats() {
                try {
                    const response = await fetch('/api/admin/dashboard/stats', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.updateDashboardStats(result.data);
                        }
                    } else {
                        console.error('Error loading dashboard stats:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error loading dashboard stats:', error);
                }
            }

            updateDashboardStats(data) {
                // Update analytics cards with the retrieved data
                document.getElementById('totalFeedback').textContent = data.totalFeedback || 0;
                document.getElementById('avgRating').textContent = data.averageRating || '0.0';
                
                // Update status counts
                document.getElementById('pendingCount').textContent = data.pendingCount || 0;
                document.getElementById('approvedCount').textContent = data.approvedCount || 0;
                document.getElementById('rejectedCount').textContent = data.rejectedCount || 0;
            }

            async loadCategoryDistribution() {
                try {
                    const response = await fetch('/api/admin/dashboard/category-distribution', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.renderCategoryChart(result.data);
                        }
                    } else {
                        console.error('Error loading category distribution:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error loading category distribution:', error);
                }
            }

            renderCategoryChart(categoryData) {
                // Get the chart canvas element
                const ctx = document.getElementById('categoryChart');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (window.categoryChart) {
                    window.categoryChart.destroy();
                }

                // Prepare data for the chart
                const labels = categoryData.map(item => item.category);
                const data = categoryData.map(item => item.count);
                const backgroundColors = [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ];

                // Create the chart
                window.categoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Feedbacks',
                            data: data,
                            backgroundColor: backgroundColors.slice(0, labels.length),
                            borderColor: backgroundColors.slice(0, labels.length).map(color => color.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Feedback Distribution by Category'
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0 // Show whole numbers only
                                }
                            }
                        }
                    }
                });
            }

            // Toast notification function
            showToast(message, type) {
                // Remove existing toasts
                const existingToasts = document.querySelectorAll('.toast-notification');
                existingToasts.forEach(toast => toast.remove());

                // Create toast element
                const toast = document.createElement('div');
                toast.className = `toast-notification toast-${type}`;
                toast.textContent = message;
                
                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.className = 'toast-close';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = () => toast.remove();
                toast.appendChild(closeBtn);

                // Add to body
                document.body.appendChild(toast);

                // Show animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 5000);
            }
        }

        // Initialize the admin dashboard when the page loads
        let adminDashboard;
        document.addEventListener('DOMContentLoaded', () => {
            adminDashboard = new AdminDashboard();
        });
    </script>
</body>
</html>